<!DOCTYPE html>
<html>
<head>
  <title>Dungeons and Daisies Runner</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      background-color: #000;
    }
    canvas {
      display: block;
      border: 2px solid #fff;
    }
  </style>
</head>
<body>
<script>
let player;
let obstacles = [];
let daisies = [];
let score = 0;
let gameOver = false;
let groundY;
let baseSpeed = -6;
let boss;
let sword;
let greenFlames = [];
let redFlames = [];
let playerRunSprites = [];
let playerRunSwordSprites = [];
let magicalSwordSprite;
let greenFlameSprite;
let currentFrame = 0;
let frameDelay = 4;
let boneSprite;
let daisySprite;
let backgroundImg;
let midgroundImg;
let titleImg;
let backgroundX = 0;
let midgroundX = 0;
let scaleFactor = 1;
let originalWidth = 800;
let originalHeight = 400;
let restartButton = null;
let isHoveringRestart = false;
let gameState = "title";
let titleStartTime;
let swordCollected = false;
let keys = {};

function preload() {
  try {
    playerRunSprites[0] = loadImage('./player_run1.png',
      () => console.log('Player run sprite 1 loaded'),
      () => console.error('Failed to load player run sprite 1')
    );
    playerRunSprites[1] = loadImage('./player_run2.png',
      () => console.log('Player run sprite 2 loaded'),
      () => console.error('Failed to load player run sprite 2'));
    playerRunSwordSprites[0] = loadImage('./run_sword1.png',
      () => console.log('Player run sword sprite 1 loaded'),
      () => console.error('Failed to load player run sword sprite 1')
    );
    playerRunSwordSprites[1] = loadImage('./run_sword2.png',
      () => console.log('Player run sword sprite 2 loaded'),
      () => console.error('Failed to load player run sword sprite 2')
    );
    magicalSwordSprite = loadImage('./powerswordgif.png',
      () => console.log('Magical sword loaded'),
      () => console.error('Failed to load magical sword sprite')
    );
    greenFlameSprite = loadImage('./greenflame.png',
      () => console.log('Green flame sprite loaded'),
      () => console.error('Failed to load green flame sprite'));
    boneSprite = loadImage('./skull.PNG',
      () => console.log('Bone sprite loaded'),
      () => console.error('Failed to load bone sprite')
    );
    daisySprite = loadImage('./daisy.PNG',
      () => console.log('Daisy sprite loaded'),
      () => console.error('Failed to load daisy sprite')
    );
    backgroundImg = loadImage('./background.png',
      () => console.log('Background loaded'),
      () => console.error('Failed to load background image')
    );
    midgroundImg = loadImage('./midground_chains.png',
      () => console.log('Midground loaded'),
      () => console.error('Failed to load midground image')
    );
    titleImg = loadImage('./Dungeons_Daisies_title.png',
      () => console.log('Title image loaded'),
      () => console.error('Failed to load title image')
    );
  } catch (e) {
    console.error('Preload error:', e);
  }
}

function setup() {
  let canvasWidth = min(windowWidth, windowHeight * 2);
  let canvasHeight = canvasWidth / 2;
  scaleFactor = canvasWidth / originalWidth;
  createCanvas(canvasWidth, canvasHeight);
  groundY = height - 50 * scaleFactor;
  player = new Player();
  textFont('VT323');
  titleStartTime = millis();
}

function windowResized() {
  let canvasWidth = min(windowWidth, windowHeight * 2);
  let canvasHeight = canvasWidth / 2;
  scaleFactor = canvasWidth / originalWidth;
  resizeCanvas(canvasWidth, canvasHeight);
  groundY = height - 50 * scaleFactor;
  if (player) player.adjustPosition();
}

class Player {
  constructor() {
    this.w = 96 * scaleFactor;
    this.h = 96 * scaleFactor;
    this.hitboxW = 64 * scaleFactor;
    this.hitboxH = 64 * scaleFactor;
    this.hitboxOffsetX = (this.w - this.hitboxW) / 2;
    this.hitboxOffsetY = (this.h - this.hitboxH) / 2;
    this.x = 100 * scaleFactor;
    this.y = groundY - this.h;
    this.vy = 0;
    this.gravity = 0.8 * scaleFactor;
    this.jumpForce = -15 * scaleFactor;
    this.isJumping = false;
    this.speed = 5 * scaleFactor;
    this.health = 100;
    this.flashTimer = 0;
  }

  jump() {
    this.vy = this.jumpForce;
    this.isJumping = true;
  }

  attack() {
    greenFlames.push(new GreenFlame(this.x + this.w, this.y + this.h / 2));
  }

  update() {
    this.vy += this.gravity;
    this.y += this.vy;
    if (this.y > groundY - this.h) {
      this.y = groundY - this.h;
      this.vy = 0;
      this.isJumping = false;
    }
    if (gameState === "boss" || (score >= 200 && !swordCollected)) {
      if (keys['ArrowLeft'] || keys['a']) this.x = max(0, this.x - this.speed);
      if (keys['ArrowRight'] || keys['d']) this.x += this.speed;
    }
  }

  show() {
    if (millis() - this.flashTimer < 200 && frameCount % 4 < 2) return;
    let sprites = swordCollected ? playerRunSwordSprites : playerRunSprites;
    if (sprites[currentFrame]) {
      image(sprites[currentFrame], this.x, this.






